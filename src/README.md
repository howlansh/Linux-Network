## Part 1. Инструмент ipcalc
* Адрес сети 192.167.38.54/13: 192.160.0.0.
* Перевод маски 255.255.255.0 в префиксную и двоичную запись: /24, 11111111.11111111.11111111.00000000.
* Перевод маски /15 в обычную и двоичную: 255.254.0.0, 11111111.11111110.00000000.00000000.
* ![](./screenshots/img_1.1.png)
* Перевод маски 11111111.11111111.11111111.11110000 в обычную и префиксную: 255,255,255,240, /28.
* Минимальный и максимальный хост в сети 12.167.38.4
* При маске /8: 12.0.0.1 - 12.255.255.254.
* При маске /16: 12.167.0.1 - 12.167.255.254.
* ![](./screenshots/img_1.2.png)
* При маске 255.255.254.0: 12.167.38.1 - 12.167.39.254.
* При маске /4: 0.0.0.1 - 15.255.255.254.
* ![](./screenshots/img_1.3.png)
* Можно ли обратиться к приложению, работающему на localhost, со следующими IP:
* 194.34.23.100 - нельзя.
* 127.0.0.2 - можно.
* 127.1.0.1 - можно.
* ![](./screenshots/img_1.4.png)
* 128.0.0.1 - нельзя.
* ![](./screenshots/img_1.5.png)
* Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных:
* 10.0.0.45 - частный.
* 134.43.0.2 - публичный.
* 192.168.4.2 - частный.
* ![](./screenshots/img_1.6.png)
* 172.20.250.4 - частный.
* 172.0.2.1 - публичный.
* 192.172.0.1 - публичный.
* ![](./screenshots/img_1.7.png)
* 172.68.0.2 - публичный.
* 172.16.255.255 - частный.
* 10.10.10.10 - частный.
* ![](./screenshots/img_1.8.png)
* 192.169.168.1 - публичный.
* Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18:
* 10.0.0.1 - невозможен.
* 10.10.0.2 - возможен.
* 10.10.10.10 - возможен.
* 10.10.100.1 - невозможен.
* 10.10.1.255 - возможен.
* ![](./screenshots/img_1.9.png)
## Part 2. Статическая маршрутизация между двумя машинами
* В настройках делаем общую сеть на виртуальных машинах.
* ![](./screenshots/img_2.5.png)
* С помощью команды "ip a" смотрим существующие сетевые интерфейсы.
* На ws1:
* ![](./screenshots/img_2.1.png)
* На ws2:
* ![](./screenshots/img_2.2.png)
* Изменённый файл etc/netplan/00-installer-config.yaml для ws1 и команда "netplan apply" для перезапуска сервиса сети.
* ![](./screenshots/img_2.3.png)
* Изменённый файл etc/netplan/00-installer-config.yaml для ws2 и команда "netplan apply".
* ![](./screenshots/img_2.4.png)
* Добавляем статический маршрут от одной машины до другой на ws1 при помощи команды "ip r add <IP> dev <DevName>" и пингуем соединение.
* ![](./screenshots/img_2.6.png)
* Одновременно добавляем статический маршрут обратно на ws2 и пингуем.
* ![](./screenshots/img_2.7.png)
* Добавляем статический маршрут на ws1 от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml и пингуем.
* ![](./screenshots/img_2.8.png)
* Аналогично на ws2.
* ![](./screenshots/img_2.9.png)
## Part 3. Утилита iperf3
* 8 Mbps = 1 MB/s.
* 100 MB/s = 800000 Kbps.
* 1 Gbps = 1000 Mbps.
* Для доступа во внешнюю сеть добавляем ещё один адаптер в настройках виртуальной машины.
* ![](./screenshots/img_3.1.png)
* Адаптер внутренней сети остаётся без изменений.
* ![](./screenshots/img_3.2.png)
* Переписываем настройки в файле etc/netplan/00-installer-config.yaml для ws1, возвращая стандартный настройки для внешней сети и прописываем настройки внутренней сети на новый адаптер.
* ![](./screenshots/img_3.3.png)
* Аналогично в файле etc/netplan/00-installer-config.yaml для ws2.
* ![](./screenshots/img_3.4.png)
* Выполняем команду "iperf3 -s -f K" на ws1, тем самым запускаем ожидание запроса от другого компьютера.
* Флаг -f используется, чтобы указать формат (k, m, g для Кбит, Мбит, Гбит или K, M, G для Кбайт, Мбайт, Гбайт) для отчета.
* ![](./screenshots/img_3.5.png)
* На ws2 выполняем "iperf3 -c <IPRemoteComp> -f K" для отправки запроса по IP адрессу и наблюдаем замер скорости.
* ![](./screenshots/img_3.6.png)
## Part 4. Сетевой экран
* Чтобы открыть порт для входящего трафика, используем команду: "iptables -A INPUT -p tcp --dport 80 -j ACCEPT".
* Флаг "-A" означает добавить правило, "-p" указывает на протокол (в данном случае TCP), "--dport" указывает на порт, а "-j" указывает, что делать с пакетами.
* ![](./screenshots/img_4.1.png)
* iptables проверяет первое подходящее правило, а значит второе (противоположное) правило уже выполняться не будет.
* ![](./screenshots/img_4.2.png)
* Таким образом видим, что с ws1 ping проходит.
* ![](./screenshots/img_4.3.png)
* Но с ws2 она не пингуется, хотя через nmap видно состояние "open".
* ![](./screenshots/img_4.4.png)
## Part 5. Статическая маршрутизация сети
* Изачально в настройках виртуальных машин настраиваем адаптеры: по 2 внутренних на r1, r2 и по 1 - на ws11, ws21, ws22. В итоге у нас получается три внутренних сети: intnet1, intnet2, intnet3. К сетям intnet1 и intnet3 подключаются виртуальные машины, а через сеть intnet2 роутеры соединяются между собой.
* ![](./screenshots/img_5.1.png)
* Прописали настройки в файле etc/netplan/00-installer-config.yaml и проверили для каждой виртуальной машины.
* r1:
* ![](./screenshots/img_5.2.png)
* r2:
* ![](./screenshots/img_5.3.png)
* ws11:
* ![](./screenshots/img_5.4.png)
* ws22:
* ![](./screenshots/img_5.5.png)
* ws21:
* ![](./screenshots/img_5.6.png)
* Пропинговали ws22 с ws21.
* ![](./screenshots/img_5.7.png)
* Пропинговали r1 с ws11.
* ![](./screenshots/img_5.8.png)
* Включаем переадресацию IP адресов командой "sysctl -w net.ipv4.ip_forward=1" на роутерах, так она включается до перезагрузки.
* На r1:
* ![](./screenshots/img_5.9.png)
* На r2:
* ![](./screenshots/img_5.10.png)
* Откроем файл /etc/sysctl.conf и раскомментим строку "net.ipv4.ip_forward = 1". Так переадресация включится на постоянной основе.
* r1:
* ![](./screenshots/img_5.11.png)
* r2:
* ![](./screenshots/img_5.12.png)
* Настраиваем маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавляем "default" перед IP роутера в файле конфигураций. Проверяем командой "ip r".
* На ws11:
* ![](./screenshots/img_5.13.png)
* На ws22:
* ![](./screenshots/img_5.14.png)
* На ws21:
* ![](./screenshots/img_5.15.png)
* На r2 выполняем "tcpdump -tn -i enp0s8", команда слушает интерфейс enp0s8 и показывает, что пинг проходит.
* ![](./screenshots/img_5.17.png)
* На ws11 пакеты отправляются, но ответ не приходит.
* ![](./screenshots/img_5.16.png)
* Прописываем маршрутизацию в r1 (обязательно указывать маску сети, иначе работать не будет):
* ![](./screenshots/img_5.18.png)
* В r2:
* ![](./screenshots/img_5.19.png)
* Маршрут по умолчанию имеет более низкий приоритет и срабатывает, когда не найден подходящий маршрут в таблице маршрутизации.
* ![](./screenshots/img_5.20.png)
* Выполняем на ws11 команду "traceroute 10.20.0.10".
* ![](./screenshots/img_5.21.png)
* "tcpdump -tnv -i enp0s8".
* ![](./screenshots/img_5.22.png)
* Для определения промежуточных маршрутизаторов traceroute отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit». Процесс повторяется до тех пор, пока пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.
* Отправляем пинг на несуществующий хост.
* ![](./screenshots/img_5.23.png)
* Запускаем "tcpdump -n -i eth0 icmp" и смотрим проходящие через r1 запросы. Видим echo request от ws11.
* ![](./screenshots/img_5.24.png)
## Part 6. Динамическая настройка IP с помощью DHCP
* На r1 в файле /etc/dhcp/dhcpd.conf настраиваем конфигурацию службы DHCP:
* ![](./screenshots/img_6.1.png)
* В файле resolv.conf прописываем nameserver 8.8.8.8.
* ![](./screenshots/img_6.2.png)
* Перезагружаем службу DHCP командой "systemctl restart isc-dhcp-server".
* ![](./screenshots/img_6.3.png)
* В сетевом конфиге на ws21 включаем получение IP через DHCP. Делаем рестарт командой "reboot".
* ![](./screenshots/img_6.4.png)
* Выполняем команду "ip a" и видим новый IP адресс. Пингуем ws22.
* ![](./screenshots/img_6.5.png)
* Изменяем конфигурацию сети на ws11.
* ![](./screenshots/img_6.6.png)
* На r1 делаем привязку к MAC адрессу.
* ![](./screenshots/img_6.7.png)
* Прописываем DNS сервер.
* ![](./screenshots/img_6.8.png)
* Проверяем пингом хостов.
* ![](./screenshots/img_6.9.png)
* Запросим на ws21 обновление ip адреса командами "dhclient -r enp0s8" и "dhclient enp0s8".
* ![](./screenshots/img_6.10.png)
## Part 7. NAT
* В файле "/etc/apache2/ports.conf" изменяем строку Listen 80 на Listen 0.0.0.0:80, то есть делаем сервер Apache2 общедоступным. Запускаем веб-сервер Apache командой "service apache2 start".
* На r1:
* ![](./screenshots/img_7.1.png)
* На ws22:
* ![](./screenshots/img_7.2.png)
* Добавляем в файерволл на r2 следующие правила:
* Удаление правил в таблице filter - "iptables -F".
* Удаление правил в таблице "NAT" - "iptables -F -t nat".
* Отбрасывать все маршрутизируемые пакеты - "iptables --policy FORWARD DROP".
* ![](./screenshots/img_7.3.png)
* Проверяем соединение между ws22 и r1 командой "ping".
* ![](./screenshots/img_7.4.png)
* При запуске с этими правилами, ws22 не пингуется с r1.
* ![](./screenshots/img_7.5.png)
* Добавляем ещё одно правило и разрешаем маршрутизацию всех пакетов протокола ICMP.
* ![](./screenshots/img_7.6.png)
* При запуске с этими правилами, ws22 пингуется с r1.
* ![](./screenshots/img_7.7.png)
* Добавляем ещё два правила:
* Включаем SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2.
* Включаем DNAT на 8080 порт машины r2 и добавляем к веб-серверу Apache, запущенному на ws22, доступ извне сети.
* ![](./screenshots/img_7.8.png)
* Проверяем соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой "telnet [адрес] [порт]".
* ![](./screenshots/img_7.9.png)
* Проверяем соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой "telnet"..
* ![](./screenshots/img_7.10.png)
## Part 8. Допополнительно. Знакомство с SSH Tunnel
* Запускаем веб-сервер Apache на ws22 только на localhost.
* ![](./screenshots/img_8.1.png)
* Воспользуемся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21. Команда "ssh -L 8080:10.20.0.20:80 howlansh@localhost".
* ![](./screenshots/img_8.2.png)
* Для проверки выполним команду "telnet 127.0.0.1 [локальный порт]".
* ![](./screenshots/img_8.3.png)
* Воспользуемся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11. Команда "ssh -R 8080:10.20.0.20:80 howlansh@localhost".
* ![](./screenshots/img_8.4.png)
* Проверка той же командой.
* ![](./screenshots/img_8.5.png)